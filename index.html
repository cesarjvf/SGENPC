<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Sing-box PC v18</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-glow: 59, 130, 246;
            --bg-color: #0f172a;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(255, 255, 255, 0.08);
            --input-bg: rgba(15, 23, 42, 0.6);
            --option-bg: rgba(30, 41, 59, 0.5);
            --terminal-bg: #0f1115;
            --terminal-header: #1e1e1e;
            --gradient-1: rgba(59, 130, 246, 0.15);
            --gradient-2: rgba(139, 92, 246, 0.15);
        }

        body.light-mode {
            --bg-color: #f0f9ff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --card-bg: rgba(255, 255, 255, 0.75);
            --card-border: rgba(0, 0, 0, 0.05);
            --input-bg: #ffffff;
            --option-bg: #ffffff;
            --terminal-bg: #f8fafc;
            --terminal-header: #e2e8f0;
            --gradient-1: rgba(96, 165, 250, 0.2);
            --gradient-2: rgba(167, 139, 250, 0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(at 0% 0%, var(--gradient-1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, var(--gradient-2) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--text-main);
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .glass-option {
            background: var(--option-bg);
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .disabled-option {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(0.8);
        }

        .modern-input {
            background: var(--input-bg);
            border: 1px solid var(--card-border);
            color: var(--text-main);
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s ease;
        }
        .modern-input:focus {
            border-color: rgba(var(--primary-glow), 0.5);
            box-shadow: 0 0 15px rgba(var(--primary-glow), 0.2);
            outline: none;
        }

        .theme-toggle-btn {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 50;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .theme-toggle-btn:hover { transform: scale(1.1); }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 4px; opacity: 0.5; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-main); }

        .toggle-checkbox { display: none; }
        .toggle-switch {
            width: 44px; height: 24px;
            background: #cbd5e1;
            border-radius: 99px;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
        }
        body:not(.light-mode) .toggle-switch { background: #334155; }
        
        .toggle-switch::after {
            content: ''; position: absolute;
            top: 3px; left: 3px;
            width: 18px; height: 18px;
            background: white;
            border-radius: 50%;
            transition: 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-checkbox:checked + .toggle-switch { background: #3b82f6; }
        .toggle-checkbox:checked + .toggle-switch::after { transform: translateX(20px); }
        .toggle-checkbox:disabled + .toggle-switch { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .mode-card { cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent; }
        .mode-card:hover { transform: translateY(-2px); }
        .mode-card.active {
            background: rgba(var(--primary-glow), 0.1);
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(var(--primary-glow), 0.15);
        }
        .mode-card.active i { color: #3b82f6; }

        .text-theme-main { color: var(--text-main); }
        .text-theme-muted { color: var(--text-muted); }
        .bg-theme-input { background: var(--input-bg); }
        
        .terminal-header { background: var(--terminal-header); border-bottom: 1px solid var(--card-border); }
        .terminal-body { background: var(--terminal-bg); }
        .code-content { color: var(--text-main); }
        body:not(.light-mode) .code-content { color: #93c5fd; }
        body.light-mode .code-content { color: #0f172a; }

        /* Custom Radio Button for Domestic DNS */
        .segmented-control {
            display: flex;
            background: rgba(0,0,0,0.2);
            border-radius: 0.5rem;
            padding: 4px;
        }
        .segment-btn {
            flex: 1;
            text-align: center;
            padding: 6px;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-muted);
        }
        .segment-btn.active {
            background: #3b82f6;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .segment-btn:hover:not(.active) {
            background: rgba(255,255,255,0.05);
        }

    </style>
</head>
<body class="min-h-screen py-10 px-4 flex justify-center items-start">

    <button id="theme-toggle" class="theme-toggle-btn" title="Cambiar Tema">
        <i class="fas fa-moon text-xl" id="theme-icon"></i>
    </button>

    <div class="w-full max-w-5xl space-y-8">
        
        <div class="text-center space-y-2">
            <h1 class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">
                Sing-box PC
            </h1>
            <p class="text-theme-muted text-sm font-light tracking-wide">GENERADOR WINDOWS / LINUX (SINTAXIS 1.12+)</p>
        </div>

        <div id="status-container" class="hidden mx-auto max-w-2xl glass-card rounded-xl p-4 text-center font-medium transition-all duration-300 text-theme-main"></div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-7 space-y-6">
                
                <div class="glass-card rounded-2xl p-6 space-y-4">
                    <div class="flex justify-between items-center">
                        <label class="text-theme-main font-semibold flex items-center gap-2">
                            <i class="fa-solid fa-link text-blue-500"></i> Enlaces de Configuraci√≥n
                        </label>
                        <span class="text-xs text-theme-muted bg-theme-input px-2 py-1 rounded border border-gray-500/20">VLESS ‚Ä¢ VMESS ‚Ä¢ TROJAN</span>
                    </div>
                    <textarea id="proxy-links" 
                        class="modern-input w-full h-40 rounded-xl p-4 text-sm placeholder-gray-500" 
                        placeholder="Pegar enlace vless://..."></textarea>
                </div>

                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-theme-main font-semibold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-desktop text-indigo-500"></i> Configuraci√≥n de Sistema
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Mode Selector -->
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-semibold text-theme-muted uppercase">Modo de Red</label>
                            <div class="grid grid-cols-2 gap-2 h-full">
                                <div id="tun-btn" class="mode-card glass-option rounded-xl p-3 text-center active flex flex-col justify-center items-center" onclick="selectMode('tun')">
                                    <i class="fa-solid fa-shield-halved text-xl mb-1 text-theme-muted"></i>
                                    <div class="font-bold text-sm text-theme-main">TUN</div>
                                </div>
                                <div id="proxy-btn" class="mode-card glass-option rounded-xl p-3 text-center flex flex-col justify-center items-center" onclick="selectMode('proxy')">
                                    <i class="fa-solid fa-globe text-xl mb-1 text-theme-muted"></i>
                                    <div class="font-bold text-sm text-theme-main">PROXY</div>
                                </div>
                            </div>
                        </div>

                        <!-- Stack Selector -->
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-semibold text-theme-muted uppercase">Tun Stack</label>
                            <div class="glass-option rounded-xl p-3 flex flex-col justify-center h-full">
                                <select id="stack-select" class="modern-input w-full rounded-lg p-2 text-sm">
                                    <option value="system" selected>System (Recomendado)</option>
                                    <option value="gvisor">gVisor (Robusto)</option>
                                    <option value="mixed">Mixed</option>
                                </select>
                                <div class="text-[10px] text-theme-muted mt-1 text-center">
                                    Motor de paquetes TCP/IP
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="mode-status-text" class="text-center text-xs text-blue-400 mt-4 font-mono opacity-80">
                        TUN: 172.18.0.1/30 (MTU 1408)
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-theme-main font-semibold mb-6 flex items-center gap-2">
                        <i class="fa-solid fa-sliders text-purple-500"></i> Ajustes Avanzados
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Domestic DNS (New Triple Design) -->
                        <div class="glass-option rounded-xl p-4 md:col-span-2 border border-blue-500/30">
                            <div class="flex justify-between items-center mb-3">
                                <div class="font-semibold text-sm text-theme-main flex items-center gap-2">
                                    <i class="fa-solid fa-house-signal text-blue-400"></i> Domestic DNS
                                </div>
                                <!-- Segmented Control Switch (Triple) -->
                                <div class="segmented-control w-64">
                                    <div id="dns-auto-btn" class="segment-btn active" onclick="setDomesticDns('auto')">Auto</div>
                                    <div id="dns-localhost-btn" class="segment-btn" onclick="setDomesticDns('localhost')">Localhost</div>
                                    <div id="dns-manual-btn" class="segment-btn" onclick="setDomesticDns('manual')">Manual</div>
                                </div>
                            </div>
                            
                            <!-- Display Areas -->
                            <div id="domestic-dns-display-container" class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3 text-center">
                                <span id="dns-display-value" class="text-blue-300 font-mono text-sm">192.168.134.242</span>
                                <div id="dns-display-label" class="text-[10px] text-theme-muted mt-1">IP Default Gateway (Baja Latencia)</div>
                            </div>

                            <!-- Manual Input -->
                            <div id="domestic-dns-manual-input" class="hidden">
                                <div class="flex items-center gap-2 mb-2 bg-slate-900/50 p-2 rounded text-xs text-theme-muted font-mono">
                                    <i class="fa-solid fa-terminal text-green-400"></i> CMD: 
                                    <span class="text-green-300">ipconfig /all</span> 
                                    <span class="opacity-50">> Servidores DNS</span>
                                </div>
                                <input type="text" id="domestic-dns-custom" 
                                    class="modern-input w-full rounded-lg p-2 text-sm text-center" 
                                    placeholder="Ej: 192.168.1.1">
                            </div>
                        </div>

                        <!-- DNS Remoto -->
                        <div id="dns-option-group" class="glass-option rounded-xl p-4 disabled-option">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-semibold text-sm text-theme-main">DNS Remoto</div>
                                    <div class="text-xs text-theme-muted">Resoluci√≥n Proxy</div>
                                </div>
                                <input type="checkbox" id="dns-toggle" class="toggle-checkbox" disabled>
                                <label for="dns-toggle" class="toggle-switch"></label>
                            </div>
                            <select id="dns-select" class="modern-input w-full rounded text-xs p-1 mt-1">
                                <option value="google">Google UDP (8.8.8.8)</option>
                                <option value="cloudflare">Cloudflare UDP (1.1.1.1)</option>
                                <option value="google_doh">Google DoH (Encrypted)</option>
                                <option value="cloudflare_doh">Cloudflare DoH (Encrypted)</option>
                            </select>
                        </div>

                        <!-- Keep Alive -->
                        <div id="keep-alive-option-group" class="glass-option rounded-xl p-4 disabled-option">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-semibold text-sm text-theme-main">Keep Alive</div>
                                    <div class="text-xs text-theme-muted">gRPC Optimizado</div>
                                </div>
                                <input type="checkbox" id="keep-alive-toggle" class="toggle-checkbox" checked disabled>
                                <label for="keep-alive-toggle" class="toggle-switch"></label>
                            </div>
                            <div class="text-[10px] text-theme-muted font-mono bg-theme-input p-2 rounded border border-gray-500/10">
                                idle_timeout: 2h<br>ping_timeout: 60s
                            </div>
                        </div>

                        <!-- Insecure -->
                        <div id="insecure-option-group" class="glass-option rounded-xl p-4 disabled-option">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-semibold text-sm text-theme-main">Insecure</div>
                                    <div class="text-xs text-theme-muted text-yellow-500">Skip Verify (SNI)</div>
                                </div>
                                <input type="checkbox" id="insecure-toggle" class="toggle-checkbox" checked disabled>
                                <label for="insecure-toggle" class="toggle-switch"></label>
                            </div>
                        </div>

                        <div id="client-fingerprint-option-group" class="glass-option rounded-xl p-4 disabled-option">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-semibold text-sm text-theme-main">uTLS Fingerprint</div>
                                    <div class="text-xs text-theme-muted">Camuflaje TLS</div>
                                </div>
                                <input type="checkbox" id="client-fingerprint-toggle" class="toggle-checkbox" disabled>
                                <label for="client-fingerprint-toggle" class="toggle-switch"></label>
                            </div>
                            <div id="client-fingerprint-details" class="hidden mt-2">
                                <select id="client-fingerprint-select" class="modern-input w-full rounded text-xs p-1">
                                    <option value="chrome" selected>Chrome</option>
                                    <option value="randomized">Aleatorio</option>
                                </select>
                            </div>
                        </div>

                        <div id="alpn-option-group" class="glass-option rounded-xl p-4 disabled-option">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-semibold text-sm text-theme-main">Forzar ALPN</div>
                                    <div class="text-xs text-theme-muted">Negociaci√≥n</div>
                                </div>
                                <input type="checkbox" id="alpn-toggle" class="toggle-checkbox" disabled>
                                <label for="alpn-toggle" class="toggle-switch"></label>
                            </div>
                            <div id="alpn-details" class="hidden mt-2">
                                <select id="alpn-select" class="modern-input w-full rounded text-xs p-1">
                                    <option value="h2" selected>h2</option>
                                    <option value="h2,http/1.1">h2, http/1.1</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 flex flex-col gap-6">
                
                <div class="glass-card rounded-2xl p-4 flex flex-col gap-3 sticky top-6 z-10">
                    <button id="generate-btn" class="w-full py-4 rounded-xl font-bold text-white text-lg flex items-center justify-center gap-2 group transition-all duration-300 bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg shadow-blue-500/30 hover:translate-y-[-2px] disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none" disabled>
                        <i class="fa-solid fa-bolt group-hover:animate-pulse"></i> GENERAR CONFIG PC
                    </button>
                    <button id="copy-btn" class="w-full py-3 rounded-xl font-semibold text-theme-main bg-gray-500/20 hover:bg-gray-500/30 transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i id="copy-icon" class="fa-solid fa-copy"></i> <span id="copy-text">Copiar JSON</span>
                    </button>
                </div>

                <div class="glass-card rounded-2xl overflow-hidden flex-1 flex flex-col min-h-[500px]">
                    <div class="terminal-header px-4 py-2 flex justify-between items-center">
                        <span class="text-xs text-theme-muted font-mono">config.json</span>
                        <div class="flex gap-1.5">
                            <div class="w-3 h-3 rounded-full bg-red-500/50"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-500/50"></div>
                            <div class="w-3 h-3 rounded-full bg-green-500/50"></div>
                        </div>
                    </div>
                    <div class="relative flex-1 terminal-body">
                        <pre class="absolute inset-0 overflow-auto p-4 scrollbar-thin"><code id="output-config" class="text-xs md:text-sm font-mono whitespace-pre-wrap break-all code-content"></code></pre>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            themeIcon.classList.replace('fa-moon', 'fa-sun');
        }

        themeToggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            themeIcon.className = isLight ? 'fas fa-sun text-xl text-orange-500' : 'fas fa-moon text-xl text-yellow-300';
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        });

        const generateBtn = document.getElementById('generate-btn');
        const copyBtn = document.getElementById('copy-btn');
        const proxyLinksInput = document.getElementById('proxy-links');
        const outputConfig = document.getElementById('output-config');
        const statusContainer = document.getElementById('status-container');
        const copyText = document.getElementById('copy-text');
        const copyIcon = document.getElementById('copy-icon');

        const tunBtn = document.getElementById('tun-btn');
        const proxyBtn = document.getElementById('proxy-btn'); 
        const modeStatusText = document.getElementById('mode-status-text');
        const stackSelect = document.getElementById('stack-select'); 
        
        // Domestic DNS UI References
        const dnsAutoBtn = document.getElementById('dns-auto-btn');
        const dnsLocalhostBtn = document.getElementById('dns-localhost-btn');
        const dnsManualBtn = document.getElementById('dns-manual-btn');
        const domesticDnsDisplayContainer = document.getElementById('domestic-dns-display-container');
        const dnsDisplayValue = document.getElementById('dns-display-value');
        const dnsDisplayLabel = document.getElementById('dns-display-label');
        const domesticDnsManualInput = document.getElementById('domestic-dns-manual-input');
        const domesticDnsCustom = document.getElementById('domestic-dns-custom');
        
        let domesticDnsMode = 'auto'; // Default

        window.setDomesticDns = function(mode) {
            domesticDnsMode = mode;
            
            // Reset active classes
            [dnsAutoBtn, dnsLocalhostBtn, dnsManualBtn].forEach(btn => btn.classList.remove('active'));

            if (mode === 'auto') {
                dnsAutoBtn.classList.add('active');
                domesticDnsDisplayContainer.classList.remove('hidden');
                domesticDnsManualInput.classList.add('hidden');
                dnsDisplayValue.textContent = '192.168.134.242';
                dnsDisplayLabel.textContent = 'IP Default Gateway (Baja Latencia)';
            } else if (mode === 'localhost') {
                dnsLocalhostBtn.classList.add('active');
                domesticDnsDisplayContainer.classList.remove('hidden');
                domesticDnsManualInput.classList.add('hidden');
                dnsDisplayValue.textContent = 'System DNS';
                dnsDisplayLabel.textContent = 'Usa la configuraci√≥n del S.O.';
            } else {
                dnsManualBtn.classList.add('active');
                domesticDnsDisplayContainer.classList.add('hidden');
                domesticDnsManualInput.classList.remove('hidden');
            }
        };
        
        let selectedMode = 'tun';

        const alpnOptionGroup = document.getElementById('alpn-option-group');
        const alpnToggle = document.getElementById('alpn-toggle');
        const alpnDetails = document.getElementById('alpn-details');
        const alpnSelect = document.getElementById('alpn-select');

        const clientFingerprintOptionGroup = document.getElementById('client-fingerprint-option-group');
        const clientFingerprintToggle = document.getElementById('client-fingerprint-toggle');
        const clientFingerprintDetails = document.getElementById('client-fingerprint-details');
        const clientFingerprintSelect = document.getElementById('client-fingerprint-select');
        
        const dnsOptionGroup = document.getElementById('dns-option-group');
        const dnsToggle = document.getElementById('dns-toggle');
        const dnsSelect = document.getElementById('dns-select');

        const keepAliveOptionGroup = document.getElementById('keep-alive-option-group');
        const keepAliveToggle = document.getElementById('keep-alive-toggle');

        const insecureOptionGroup = document.getElementById('insecure-option-group');
        const insecureToggle = document.getElementById('insecure-toggle');

        let validProxies = [];
        let validationTimeout;
        const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        
        window.selectMode = function(mode) {
            selectedMode = mode;
            if (mode === 'tun') {
                tunBtn.classList.add('active');
                proxyBtn.classList.remove('active');
                modeStatusText.textContent = 'TUN: 172.18.0.1/30 (MTU 1408)';
                stackSelect.disabled = false;
                stackSelect.parentElement.classList.remove('opacity-50');
            } else {
                proxyBtn.classList.add('active');
                tunBtn.classList.remove('active');
                modeStatusText.textContent = 'PROXY: 127.0.0.1:10808 (SOCKS/HTTP)';
                stackSelect.disabled = true; // Stack only for TUN
                stackSelect.parentElement.classList.add('opacity-50');
            }
        };

        function setupToggleLogic(toggle, details) {
            if (!details) return;
            toggle.addEventListener('change', () => {
                if (toggle.checked) {
                    details.classList.remove('hidden');
                } else {
                    details.classList.add('hidden');
                }
            });
        }
        setupToggleLogic(alpnToggle, alpnDetails);
        setupToggleLogic(clientFingerprintToggle, clientFingerprintDetails);
        
        function enableGroup(group, toggle) {
            group.classList.remove('disabled-option');
            toggle.disabled = false;
        }
        function disableGroup(group, toggle, details) {
            group.classList.add('disabled-option');
            toggle.disabled = true;
            toggle.checked = false;
            if(details) details.classList.add('hidden');
        }

        function toggleAdvancedOptionsState(isTlsAvailable, isGrpcAvailable, hasLink) {
            if (hasLink) {
                enableGroup(dnsOptionGroup, dnsToggle);
                if (isGrpcAvailable) {
                    enableGroup(keepAliveOptionGroup, keepAliveToggle);
                    keepAliveToggle.checked = true;
                } else {
                    disableGroup(keepAliveOptionGroup, keepAliveToggle);
                }
            } else {
                disableGroup(keepAliveOptionGroup, keepAliveToggle);
                disableGroup(dnsOptionGroup, dnsToggle);
            }

            if (isTlsAvailable) {
                enableGroup(alpnOptionGroup, alpnToggle);
                enableGroup(clientFingerprintOptionGroup, clientFingerprintToggle);
                enableGroup(insecureOptionGroup, insecureToggle);
                insecureToggle.checked = true; 
            } else {
                disableGroup(alpnOptionGroup, alpnToggle, alpnDetails);
                disableGroup(clientFingerprintOptionGroup, clientFingerprintToggle, clientFingerprintDetails);
                disableGroup(insecureOptionGroup, insecureToggle);
            }
        }
        
        proxyLinksInput.addEventListener('input', () => {
            generateBtn.disabled = true;
            copyBtn.disabled = true;
            outputConfig.textContent = '';
            clearTimeout(validationTimeout);
            
            const links = proxyLinksInput.value.trim().split('\n').filter(link => link.trim() !== '');
            if (links.length === 0) {
                statusContainer.classList.add('hidden');
                validProxies = [];
                toggleAdvancedOptionsState(false, false, false);
                return;
            }

            statusContainer.classList.remove('hidden');
            setStatus('‚è≥ Verificando enlace...', 'loading');
            
            validationTimeout = setTimeout(() => {
                const results = links.map((link, index) => parseAndValidateLink(link, index));
                const errors = results.filter(r => r.errors.length > 0);
                
                validProxies = results.filter(r => r.errors.length === 0).map(r => r.proxy);
                
                const isTlsAvailable = validProxies.some(p => p.tls);
                const isGrpcAvailable = validProxies.some(p => p.network === 'grpc');
                
                toggleAdvancedOptionsState(isTlsAvailable, isGrpcAvailable, true);
                
                if (errors.length > 0) {
                    const errorMessage = errors.map(e => e.errors.join(' ')).join(' | ');
                    setStatus(`‚ùå ${errorMessage}`, 'error');
                    generateBtn.disabled = true;
                } else if (validProxies.length > 0) {
                    setStatus('‚úÖ Enlace v√°lido. Listo para generar.', 'success');
                    generateBtn.disabled = false;
                } else {
                    setStatus('‚ùå Formato no reconocido.', 'error');
                    generateBtn.disabled = true;
                }
            }, 500);
        });
        
        generateBtn.addEventListener('click', () => {
            if (validProxies.length > 0) {
                const jsonConfig = generateSingboxConfig(validProxies);
                outputConfig.textContent = jsonConfig;
                setStatus('üöÄ ¬°Configuraci√≥n PC Generada!', 'success');
                copyBtn.disabled = false;
            }
        });

        copyBtn.addEventListener('click', () => {
            if (outputConfig.textContent) {
                try {
                    const textarea = document.createElement('textarea');
                    textarea.value = outputConfig.textContent;
                    textarea.style.position = 'fixed';
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    copyText.textContent = '¬°Copiado!';
                    copyIcon.className = 'fa-solid fa-check text-blue-500';
                    setTimeout(() => {
                        copyText.textContent = 'Copiar JSON';
                        copyIcon.className = 'fa-solid fa-copy';
                    }, 2000);
                } catch (err) {
                    console.error('Error al copiar: ', err);
                    setStatus('‚ùå Error al copiar', 'error');
                }
            }
        });

        function setStatus(message, type) {
            statusContainer.className = 'mx-auto max-w-2xl glass-card rounded-xl p-3 text-center font-medium transition-all duration-300 mb-6 text-sm';
            
            if (type === 'loading') {
                statusContainer.classList.add('text-theme-muted', 'verificando');
                statusContainer.style.borderColor = 'rgba(255,255,255,0.1)';
            } else if (type === 'error') {
                statusContainer.classList.add('text-red-400', 'bg-red-500/10');
                statusContainer.style.borderColor = 'rgba(239, 68, 68, 0.3)';
            } else if (type === 'success') {
                statusContainer.classList.add('text-blue-400', 'bg-blue-500/10');
                statusContainer.style.borderColor = 'rgba(59, 130, 246, 0.3)';
            }
            statusContainer.innerHTML = message;
        }

        // --- PARSING LOGIC ---
        function parseAndValidateLink(link, index) {
            const result = { proxy: null, errors: [], warnings: [] };
            try {
                let p;
                if (link.startsWith('vless://')) p = parseVless(link, index, result);
                else if (link.startsWith('vmess://')) p = parseVmess(link, index, result);
                else if (link.startsWith('trojan://')) p = parseTrojan(link, index, result);
                else {
                    result.errors.push(`Protocolo no soportado.`);
                    return result;
                }
                
                if (!p.server) result.errors.push(`Falta servidor.`);
                if (!p.port || isNaN(p.port)) result.errors.push(`Puerto inv√°lido.`);
                if ((p.type === 'vless' || p.type === 'vmess') && (!p.uuid || !UUID_REGEX.test(p.uuid))) {
                    result.errors.push(`UUID inv√°lido.`);
                }
                result.proxy = p;
            } catch (e) {
                result.errors.push(`Error: ${e.message}`);
            }
            return result;
        }

        function parseVless(link, index, result) {
            const url = new URL(link);
            const params = new URLSearchParams(url.search);
            const proxy = {
                type: 'vless',
                server: url.hostname,
                port: parseInt(url.port, 10),
                uuid: String(url.username || '').trim(),
                network: params.get('type') || 'tcp',
                name: decodeURIComponent(url.hash.substring(1)) || `VLESS_${index}`
            };

            const security = params.get('security');
            proxy.tls = (security === 'tls' || security === 'reality' || security === 'xtls');
            proxy.servername = params.get('sni') || params.get('servername') || proxy.server;
            
            if (security === 'reality') {
                proxy.security = 'reality';
                proxy.fp = params.get('fp');
                proxy.pbk = params.get('pbk');
                proxy.spx = params.get('spx');
            }

            if (proxy.network === 'grpc') {
                proxy['grpc-opts'] = { 'grpc-service-name': params.get('serviceName') || '' };
            } else if (proxy.network === 'ws') {
                proxy['ws-opts'] = {
                    path: params.get('path') || '/',
                    headers: { Host: params.get('host') || proxy.servername }
                };
            }
            return proxy;
        }

        function parseVmess(link, index, result) {
            let decoded;
            try { decoded = JSON.parse(atob(link.substring(8))); } 
            catch (e) { result.errors.push('Base64 inv√°lido.'); return {}; }
            
            const proxy = {
                type: 'vmess',
                server: decoded.add,
                port: parseInt(decoded.port, 10),
                uuid: decoded.id,
                alterId: parseInt(decoded.aid || 0),
                cipher: decoded.scy || 'auto',
                network: decoded.net || 'tcp',
                name: decoded.ps || `VMess_${index}`
            };

            proxy.tls = (decoded.tls === 'tls');
            proxy.servername = decoded.sni || proxy.server;

            if (proxy.network === 'grpc') {
                proxy['grpc-opts'] = { 'grpc-service-name': decoded.path || decoded.serviceName || '' }; 
            } else if (proxy.network === 'ws') {
                proxy['ws-opts'] = {
                    path: decoded.path || '/',
                    headers: { Host: decoded.host || proxy.servername }
                };
            }
            return proxy;
        }

        function parseTrojan(link, index, result) {
            const url = new URL(link);
            const params = new URLSearchParams(url.search);
            const proxy = {
                type: 'trojan',
                server: url.hostname,
                port: parseInt(url.port, 10),
                password: decodeURIComponent(url.username),
                network: params.get('type') || 'tcp',
                name: decodeURIComponent(url.hash.substring(1)) || `Trojan_${index}`
            };
            
            proxy.tls = (params.get('security') === 'tls' || params.get('security') === 'reality' || url.port == 443);
            proxy.servername = params.get('sni') || proxy.server;

            if (proxy.network === 'grpc') {
                proxy['grpc-opts'] = { 'grpc-service-name': params.get('serviceName') || '' };
            } else if (proxy.network === 'ws') {
                proxy['ws-opts'] = {
                    path: params.get('path') || '/',
                    headers: { Host: params.get('host') || proxy.servername }
                };
            }
            return proxy;
        }

        function generateSingboxConfig(proxies) {
            
            const isDnsCustomEnabled = dnsToggle.checked;
            const selectedRemoteDns = dnsSelect.value;
            const domesticIpInput = domesticDnsCustom.value.trim();
            const defaultDomesticIp = "192.168.134.242";
            
            // Define server objects
            let remoteDnsServer = "udp://8.8.8.8"; // Default
            if (selectedRemoteDns === 'google') remoteDnsServer = "udp://8.8.8.8";
            else if (selectedRemoteDns === 'cloudflare') remoteDnsServer = "udp://1.1.1.1";
            else if (selectedRemoteDns === 'google_doh') remoteDnsServer = "https://8.8.8.8/dns-query";
            else if (selectedRemoteDns === 'cloudflare_doh') remoteDnsServer = "https://1.1.1.1/dns-query";

            const remoteDns = { 
                "tag": "remote_dns", 
                "address": remoteDnsServer, 
                "detour": "proxy" 
            };
            
            // Domestic DNS Logic (Localhost / Auto / Manual)
            let domesticDns;
            if (domesticDnsMode === 'localhost') {
                 // Localhost: System DNS
                 domesticDns = { "tag": "domestic_dns", "type": "local" }; // No detour direct here (safe)
            } else {
                 // Auto or Manual IP
                 let finalIp = (domesticDnsMode === 'manual' && domesticIpInput) ? domesticIpInput : defaultDomesticIp;
                 
                 if (!finalIp.includes('://') && finalIp !== 'local') {
                    finalIp = `udp://${finalIp}`;
                 }
                 domesticDns = { "tag": "domestic_dns", "address": finalIp, "detour": "direct" }; 
                 // Note: Detour direct removed in previous strict version for safety, 
                 // but standard practice for IP DNS is direct. If it fails, remove detour.
                 // Re-adding detour: direct because user confirmed v2rayN uses it and works, 
                 // BUT sing-box 1.12 might complain if it's redundant. 
                 // FIX: Let's remove 'detour' for domestic IP to be safe and let routing handle it.
                 delete domesticDns.detour; 
            }

            const localDns = { "tag": "local", "type": "local" };
            
            const dnsServers = [remoteDns, domesticDns, localDns];
            if (!isDnsCustomEnabled) {
                // Fallback
                dnsServers.push({ "tag": "backup_dns", "address": "udp://8.8.4.4", "detour": "proxy" });
            }

            const config = {
                "log": { "level": "error", "timestamp": true }, 
                "dns": { 
                    "servers": dnsServers,
                    "rules": [
                        { "domain_suffix": [".local", ".home", ".arpa", ".lan", ".test", ".localhost"], "server": "domestic_dns" },
                        { "clash_mode": "direct", "server": "domestic_dns" }
                    ],
                    "final": "remote_dns",
                    "strategy": "ipv4_only" 
                },
                "inbounds": [],
                "outbounds": [],
                "route": {
                    "rules": [
                        { "protocol": "dns", "action": "hijack-dns" },
                        { "ip_is_private": true, "outbound": "direct" }
                    ],
                    "final": "proxy",
                    "auto_detect_interface": true,
                    "default_domain_resolver": "local" 
                }
            };

            if (selectedMode === 'tun') {
                config.inbounds.push({
                    "type": "tun",
                    "tag": "tun-in",
                    "interface_name": "tun0",
                    "address": ["172.18.0.1/30"],
                    "mtu": 1408,
                    "auto_route": true,
                    "strict_route": true,
                    "stack": stackSelect.value, // User selected stack
                    "sniff": true
                });
            } else {
                config.inbounds.push({
                    "type": "mixed",
                    "tag": "mixed-in",
                    "listen": "127.0.0.1",
                    "listen_port": 10808,
                    "sniff": true
                });
            }

            const p = proxies[0]; 
            
            const outbound = {
                "type": p.type,
                "tag": "proxy",
                "server": p.server,
                "server_port": p.port
            };

            if (p.type === 'vless') {
                outbound.uuid = p.uuid;
                outbound.packet_encoding = "xudp"; 
            } else if (p.type === 'vmess') {
                outbound.uuid = p.uuid;
                outbound.alter_id = p.alterId;
                outbound.security = p.cipher;
            } else if (p.type === 'trojan') {
                outbound.password = p.password;
            }

            if (p.network === 'grpc') {
                outbound.transport = {
                    "type": "grpc",
                    "service_name": p['grpc-opts']?.['grpc-service-name'] || "gun"
                };
                if (keepAliveToggle.checked) {
                    outbound.transport.idle_timeout = "2h";
                    outbound.transport.ping_timeout = "60s";
                    outbound.transport.permit_without_stream = true;
                }
            } else if (p.network === 'ws') {
                outbound.transport = {
                    "type": "ws",
                    "path": p['ws-opts']?.path || "/",
                    "headers": p['ws-opts']?.headers || {}
                };
            }

            if (p.tls) {
                outbound.tls = {
                    "enabled": true,
                    "server_name": p.servername,
                    "insecure": insecureToggle.checked 
                };
                
                if (clientFingerprintToggle.checked) {
                    outbound.tls.utls = {
                        "enabled": true,
                        "fingerprint": clientFingerprintSelect.value
                    };
                }

                if (alpnToggle.checked) {
                    outbound.tls.alpn = alpnSelect.value.split(',').map(s => s.trim());
                }

                if (p.security === 'reality') {
                    outbound.tls.reality = {
                        "enabled": true,
                        "public_key": p.pbk,
                        "short_id": p.spx || ""
                    };
                    outbound.tls.utls = {
                        "enabled": true,
                        "fingerprint": p.fp || "chrome"
                    };
                }
            }

            config.outbounds.push(outbound);
            config.outbounds.push(
                { "type": "direct", "tag": "direct" }
            );

            return JSON.stringify(config, null, 2);
        }
    });
    </script>
</body>
</html>
